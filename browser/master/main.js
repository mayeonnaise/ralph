!function(e){var n={};function t(s){if(n[s])return n[s].exports;var o=n[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:s})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(t.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(s,o,function(n){return e[n]}.bind(null,o));return s},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=1)}([function(e,n,t){"use strict";t.r(n),t.d(n,"Block",(function(){return i})),t.d(n,"Blockchain",(function(){return o}));let{Haiku:s}=t(3);class o{constructor(e){this.chain=[],this.currentBlock=null,e&&this.genesis()}appendBlock(e){this.chain.push(e)}async newBlock(e){console.log(this.chain);const n=this.chain[this.chain.length-1],t=await n.hash();var s=new i(e,t);this.currentBlock=s}async mine(e){for(;!await this.currentBlock.verify();)this.currentBlock.nonce+=1;console.log("mined"),e(this.currentBlock)}genesis(){const e=new i(new s("genesis",0,""),new Uint8Array([0,0,0,0]));this.chain.push(e)}}class i{constructor(e,n){this.timestamp=(new Date).getTime(),this.payload=e,this.nonce=1e3*Math.random(),this.previousHash=n}async verify(){return(await this.hash()).slice(0,2).every(e=>0===e)}async hash(){const e=(new TextEncoder).encode(JSON.stringify(this)),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n))}}},function(e,n,t){t(2),e.exports=t(0)},function(e,n,t){let{Block:s,Blockchain:o}=t(0),{WebRTCClient:i}=t(4);const c=new o(!0);new i("master",(function(e){const n=JSON.parse(e.data);switch(n.type){case"block":{const e=Object.assign(new s,n.block);c.appendBlock(e);break}case"ledger":for(block of(ledger=Object.assign(new o,n.blockchain),console.log(ledger),newChain=[],ledger.chain))console.log(block),newBlock=Object.assign(new s,block),newChain.push(newBlock),console.log(newBlock);c.chain.length<ledger.chain.length&&(c.chain=newChain)}}),(function(){var e={type:"ledger",blockchain:c};return JSON.stringify(e)}))},function(e,n,t){"use strict";t.r(n),t.d(n,"Haiku",(function(){return s}));class s{constructor(e,n,t){this.lineno=n,this.line=t,this.id=e}}},function(e,n,t){"use strict";t.r(n),t.d(n,"WebRTCClient",(function(){return s}));class s{constructor(e,n,t,s){this.id=e,this.ws=new WebSocket("ws://localhost:80/ws/"+e),this.configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},this.connections={},this.channels={},this.connectionsStatus={},this.parseMessageCallback=n,this.prepareLedgerMsg=t,this.hideLoadingPage=s,this.setupWebsocket()}setupReceiveChannel(e,n){n.ondatachannel=function(n){this.channels[e]=n.channel;this.channels[e].onmessage=this.parseMessageCallback}.bind(this)}setupSendChannel(e,n){const t=n.createDataChannel("sendChannel");this.channels[e]=t,t.onopen=function(){t.send(this.prepareLedgerMsg())}.bind(this),t.onclose=function(){t.send(JSON.stringify({type:"close",msg:"Successfully closed data channel"}))},t.onmessage=this.parseMessageCallback}handleSendSetup(e){this.connections[e]=new RTCPeerConnection(this.configuration),this.connectionsStatus[e]=!1;const n=this.connections[e];console.log("Creating new WebRTC Peer connection"),this.setupSendChannel(e,n),this.setupPeerConnection(e,n)}handleReceiveSetup(e){this.connections[e]=new RTCPeerConnection(this.configuration),this.connectionsStatus[e]=!1;const n=this.connections[e];console.log("Creating new WebRTC Peer connection"),this.setupReceiveChannel(e,n),this.setupPeerConnection(e,n)}async sendOffer(e){const n=this.connections[e];console.log(n);const t=await n.createOffer();await n.setLocalDescription(t),console.log(t);var s={type:"offer",sender:this.id,sendee:e,offer:t};this.ws.send(JSON.stringify(s))}async handleOffer(e,n,t){if(n!==this.id)return;const s=this.connections[e];s.setRemoteDescription(new RTCSessionDescription(t));const o=await s.createAnswer();await s.setLocalDescription(o);var i={type:"answer",sender:this.id,sendee:e,answer:o};this.ws.send(JSON.stringify(i))}async handleAnswer(e,n,t){if(n!==this.id)return;const s=this.connections[e],o=new RTCSessionDescription(t);await s.setRemoteDescription(o),console.log("Set answer"),console.log(s)}async handleIceCandidate(e,n,t){if(n!==this.id)return;const s=this.connections[e];if(console.log(e),console.log(this.connections),t)try{await s.addIceCandidate(t)}catch(e){console.error("Error adding received ice candidate",e)}}setupWebsocket(){this.ws.onopen=function(){var e={type:"introduction",id:this.id};console.log(this),this.ws.send(JSON.stringify(e))}.bind(this),this.ws.onmessage=function(e){var n=JSON.parse(e.data);switch(console.log(n),n.type){case"introduction":this.handleSendSetup(n.id),this.sendOffer(n.id);break;case"offer":this.handleReceiveSetup(n.sender),this.handleOffer(n.sender,n.sendee,n.offer);break;case"answer":this.handleAnswer(n.sender,n.sendee,n.answer);break;case"ice-candidate":console.log(n),this.handleIceCandidate(n.sender,n.sendee,n.candidate)}}.bind(this)}setupPeerConnection(e,n){console.log(e),console.log(n),n.onicecandidate=function(n){if(n.candidate){var t={type:"ice-candidate",sender:this.id,sendee:e,candidate:n.candidate};this.ws.send(JSON.stringify(t))}}.bind(this),n.onicecandidateerror=function(e){e.errorCode>=300&&e.errorCode<=699?console.log(e):e.errorCode>=700&&e.errorCode<=799&&(console.log("Server could not be reached"),console.log(e))},n.oniceconnectionstatechange=function(t){console.log(t),"connected"===n.connectionState?(this.connectionsStatus[e]=!0,console.log("Connected to "+e)):console.log("failed")}.bind(this),n.onconnectionstatechange=function(e){switch(n.connectionState){case"connected":"none"!==document.getElementById("loading").style.display&&this.hideLoadingPage()}}.bind(this)}}}]);