!function(e){var n={};function t(i){if(n[i])return n[i].exports;var o=n[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:i})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(i,o,function(n){return e[n]}.bind(null,o));return i},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=2)}([function(e,n,t){"use strict";t.r(n),t.d(n,"Block",(function(){return s})),t.d(n,"Blockchain",(function(){return o}));let{Haiku:i}=t(1);class o{constructor(e){this.chain=[],this.currentBlock=null,e&&this.genesis()}appendBlock(e){this.chain.push(e)}async newBlock(e){console.log(this.chain);const n=this.chain[this.chain.length-1],t=await n.hash();var i=new s(e,t);this.currentBlock=i}async mine(e){for(;!await this.currentBlock.verify();)this.currentBlock.nonce+=1;console.log("mined"),e(this.currentBlock)}genesis(){const e=new s(new i("genesis",0,""),new Uint8Array([0,0,0,0]));this.chain.push(e)}}class s{constructor(e,n){this.timestamp=(new Date).getTime(),this.payload=e,this.nonce=1e3*Math.random(),this.previousHash=n}async verify(){return(await this.hash()).slice(0,2).every(e=>0===e)}async hash(){const e=(new TextEncoder).encode(JSON.stringify(this)),n=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(n))}}},function(e,n,t){"use strict";t.r(n),t.d(n,"Haiku",(function(){return i}));class i{constructor(e,n,t){this.lineno=n,this.line=t,this.id=e}}},function(e,n,t){t(3),e.exports=t(0)},function(e,n,t){let{Block:i,Blockchain:o}=t(0),{Haiku:s}=t(1),{BlockchainMiner:c}=t(4),{WebRTCClient:a}=t(5);const l=(new Date).getTime(),d=new o("master"===l),r=new c(d);var u={},h={},m=null;function g(){for(var e of(u={},console.log(d.chain),d.chain)){console.log(e);const n=e.payload;u[n.id]=void 0===u[n.id]?{}:u[n.id],u[n.id][n.lineno]=n.line,h[n.id]=void 0===h[n.id]||h[n.id]<n.lineno?n.lineno:h[n.id]}console.log(h)}function f(e,n){const t=document.createElement("div");t.setAttribute("class","haiku");const i=document.createElement("img");i.setAttribute("src","ancient-scroll.svg"),i.setAttribute("class","haikuimg"),t.onclick=function(){console.log(n);var t=[];const i=u[e];for(var o in console.log(u),i)t.push([o,i[o]]);t.sort((function(e,n){return e[0]-n[0]})),console.log("this"),console.log(t);const s=document.getElementById("submitdiv");document.getElementById("blockchain").innerHTML="",document.getElementById("blockchain").appendChild(s);for(var c=0;c<t.length;c++)if(t[c][0]>=0&&t[c][0]<3){console.log(document.getElementById("blockchain").children);var a=document.createElement("p");a.appendChild(document.createTextNode(t[c][1])),document.getElementById("blockchain").insertBefore(a,document.getElementById("submitdiv"))}document.getElementById("contents").setAttribute("style","display:none;"),document.getElementById("blockchain").setAttribute("style","display:flex;"),m=e,console.log(h),h[m]>=2?document.getElementById("submitdiv").setAttribute("style","display:none;"):document.getElementById("submitdiv").setAttribute("style","display:flex;")},console.log(t);const o=document.createElement("span");return o.appendChild(document.createTextNode(e)),t.appendChild(o),t.append(i),t}function p(e){for(var n in haiku_ids=[],haiku_elements=[],document.getElementById("contentspage").innerHTML="",console.log(e),e)haiku_ids.includes(n)||"genesis"===n||(haiku_elements.push(f(n,e[n])),haiku_ids.push(n));haiku_elements.forEach(e=>{document.getElementById("contentspage").appendChild(e)})}document.getElementById("title").onclick=function(){document.getElementById("contents").setAttribute("style","display:flex;"),document.getElementById("blockchain").setAttribute("style","display:none;")};const y=new a(l,(function(e){const n=JSON.parse(e.data);switch(console.log(n),n.type){case"block":{r.terminate();const e=Object.assign(new i,n.block);if(d.appendBlock(e),""!==e.payload.line&&e.payload.id===m){var t=document.createElement("p");t.appendChild(document.createTextNode(e.payload.line)),document.getElementById("blockchain").insertBefore(t,document.getElementById("submitdiv"))}g(),p(u);break}case"ledger":for(var s of(ledger=Object.assign(new o,n.blockchain),console.log(ledger),newChain=[],newOutput="",ledger.chain))newBlock=Object.assign(new i,s),newChain.push(newBlock);d.chain.length<ledger.chain.length&&(d.chain=newChain,g(),p(u))}}),(function(){var e={type:"ledger",blockchain:d};return JSON.stringify(e)}),(function(){console.log("here hiding"),document.getElementById("loading").setAttribute("style","display:none;"),document.getElementById("main").setAttribute("style","display:flex;")}));function b(e){if(""!==e.payload.line){var n=document.createElement("p");n.appendChild(document.createTextNode(e.payload.line)),document.getElementById("blockchain").insertBefore(n,document.getElementById("submitdiv"))}v(e),d.appendBlock(e),g(),document.getElementById("submit").disabled=!1}function k(){document.getElementById("submit").disabled=!1}function w(e){if(""!==e.payload.line){var n=document.createElement("p");n.appendChild(document.createTextNode(e.payload.line)),document.getElementById("blockchain").insertBefore(n,document.getElementById("submitdiv"))}v(e),d.appendBlock(e),g(),p(u),document.getElementById("submithaiku").disabled=!1}function B(){document.getElementById("submithaiku").disabled=!1}function v(e){for(var n in console.log(y.channels),y.channels)if(channel=y.channels[n],"open"===channel.readyState){var t={type:"block",block:e};channel.send(JSON.stringify(t)),console.log("sent")}}null!==d.currentBlock&&(document.getElementById("submit").disabled=!1),document.getElementById("submit").onclick=async function(){const e=document.getElementById("text").value,n=new s(m,h[m]+1,e);console.log("mining..."),document.getElementById("text").value="",document.getElementById("submit").disabled=!0,await r.mine(n,b,k)},document.getElementById("submithaiku").onclick=async function(){const e=document.getElementById("haikuname").value,n=new s(e,-1,"");console.log("mining..."),document.getElementById("haikuname").value="",document.getElementById("submit").disabled=!0,await r.mine(n,w,B)}},function(e,n,t){"use strict";t.r(n),t.d(n,"BlockchainMiner",(function(){return i}));class i{constructor(e){this.blockchain=e,this.mining_status=!0}async mine(e,n,t){for(this.mining_status=!0,await this.blockchain.newBlock(e);!await this.blockchain.currentBlock.verify()&&this.mining_status;)this.blockchain.currentBlock.nonce+=1;this.mining_status?(console.log("mined"),n(this.blockchain.currentBlock)):t()}terminate(){this.mining_status=!1}}},function(e,n,t){"use strict";t.r(n),t.d(n,"WebRTCClient",(function(){return i}));class i{constructor(e,n,t,i){this.id=e,this.ws=new WebSocket("ws://localhost:80/ws/"+e),this.configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},this.connections={},this.channels={},this.connectionsStatus={},this.parseMessageCallback=n,this.prepareLedgerMsg=t,this.hideLoadingPage=i,this.setupWebsocket()}setupReceiveChannel(e,n){n.ondatachannel=function(n){this.channels[e]=n.channel;this.channels[e].onmessage=this.parseMessageCallback}.bind(this)}setupSendChannel(e,n){const t=n.createDataChannel("sendChannel");this.channels[e]=t,t.onopen=function(){t.send(this.prepareLedgerMsg())}.bind(this),t.onclose=function(){t.send(JSON.stringify({type:"close",msg:"Successfully closed data channel"}))},t.onmessage=this.parseMessageCallback}handleSendSetup(e){this.connections[e]=new RTCPeerConnection(this.configuration),this.connectionsStatus[e]=!1;const n=this.connections[e];console.log("Creating new WebRTC Peer connection"),this.setupSendChannel(e,n),this.setupPeerConnection(e,n)}handleReceiveSetup(e){this.connections[e]=new RTCPeerConnection(this.configuration),this.connectionsStatus[e]=!1;const n=this.connections[e];console.log("Creating new WebRTC Peer connection"),this.setupReceiveChannel(e,n),this.setupPeerConnection(e,n)}async sendOffer(e){const n=this.connections[e];console.log(n);const t=await n.createOffer();await n.setLocalDescription(t),console.log(t);var i={type:"offer",sender:this.id,sendee:e,offer:t};this.ws.send(JSON.stringify(i))}async handleOffer(e,n,t){if(n!==this.id)return;const i=this.connections[e];i.setRemoteDescription(new RTCSessionDescription(t));const o=await i.createAnswer();await i.setLocalDescription(o);var s={type:"answer",sender:this.id,sendee:e,answer:o};this.ws.send(JSON.stringify(s))}async handleAnswer(e,n,t){if(n!==this.id)return;const i=this.connections[e],o=new RTCSessionDescription(t);await i.setRemoteDescription(o),console.log("Set answer"),console.log(i)}async handleIceCandidate(e,n,t){if(n!==this.id)return;const i=this.connections[e];if(console.log(e),console.log(this.connections),t)try{await i.addIceCandidate(t)}catch(e){console.error("Error adding received ice candidate",e)}}setupWebsocket(){this.ws.onopen=function(){var e={type:"introduction",id:this.id};console.log(this),this.ws.send(JSON.stringify(e))}.bind(this),this.ws.onmessage=function(e){var n=JSON.parse(e.data);switch(console.log(n),n.type){case"introduction":this.handleSendSetup(n.id),this.sendOffer(n.id);break;case"offer":this.handleReceiveSetup(n.sender),this.handleOffer(n.sender,n.sendee,n.offer);break;case"answer":this.handleAnswer(n.sender,n.sendee,n.answer);break;case"ice-candidate":console.log(n),this.handleIceCandidate(n.sender,n.sendee,n.candidate)}}.bind(this)}setupPeerConnection(e,n){console.log(e),console.log(n),n.onicecandidate=function(n){if(n.candidate){var t={type:"ice-candidate",sender:this.id,sendee:e,candidate:n.candidate};this.ws.send(JSON.stringify(t))}}.bind(this),n.onicecandidateerror=function(e){e.errorCode>=300&&e.errorCode<=699?console.log(e):e.errorCode>=700&&e.errorCode<=799&&(console.log("Server could not be reached"),console.log(e))},n.oniceconnectionstatechange=function(t){console.log(t),"connected"===n.connectionState?(this.connectionsStatus[e]=!0,console.log("Connected to "+e)):console.log("failed")}.bind(this),n.onconnectionstatechange=function(e){switch(n.connectionState){case"connected":"none"!==document.getElementById("loading").style.display&&this.hideLoadingPage()}}.bind(this)}}}]);